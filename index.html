<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¤×œ×¦×•×ª ×”×—×©×‘×•×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ×˜×¢×™× ×ª Tone.js ×œ×¦×œ×™×œ×™ ××©×•×‘ -->
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* ×”×’×“×¨×ª ×’×•×¤×Ÿ Varela Round ×œ×ª××™×›×” ×™×¤×” ×‘×¢×‘×¨×™×ª */
        body {
            font-family: 'Varela Round', sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #c9e6ff 100%);
        }
        /* ×¡×’× ×•×Ÿ ×›×œ×œ×™ ×œ×›×“×•×¨×™× ×•×œ×—×¨×™×¦×™× */
        .orb, .slot, .mc-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .orb:hover, .mc-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .slot {
            background-color: #e0f2fe; /* light blue for empty slot */
            border: 4px dashed #90cdf4;
            color: #6366f1;
        }
        .monster-reaction {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            animation: fadePop 1s ease-out;
        }
        @keyframes fadePop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.3); }
        }

        .confetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 50;
        }
        .op-button {
            padding: 8px 12px;
            border-radius: 9999px;
            font-weight: bold;
            transition: background-color 0.2s, transform 0.1s;
        }
        .op-button:hover:not(.active) {
            transform: translateY(-1px);
        }
        .op-button.active {
            background-color: #0d9488; /* teal-600 */
            color: white;
            box-shadow: 0 4px 6px rgba(13, 148, 136, 0.4);
        }

        /* ×¡×’× ×•×Ÿ ×œ×›×¤×ª×•×¨×™ ×‘×—×™×¨×” ××¨×•×‘×” */
        .mc-button {
            width: 100%;
            height: 64px;
            background-color: #fca5a5; /* Red/Pink */
            color: #881337;
            border-radius: 12px;
            font-size: 2rem;
        }
        .mc-button.correct {
            background-color: #6ee7b7; /* Green */
        }
        .mc-button.incorrect {
            background-color: #fca5a5; /* Red */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-6 flex flex-col gap-4" style="min-height: 80vh;">

        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¢×œ×™×•× ×•×ª -->
        <div class="flex justify-between text-lg font-medium text-gray-700">
            <div>
                × ×™×§×•×“: <span id="score-display" class="text-blue-600 font-extrabold">0</span>
            </div>
            <div>
                ×¨×¦×£ × ×™×¦×—×•× ×•×ª: <span id="streak-display" class="text-pink-600 font-extrabold">0</span>
            </div>
        </div>
        
        <!-- ×‘×—×™×¨×ª ×¤×¢×•×œ×” ×•××¢×‘×¨ ××¦×‘ -->
        <div class="flex flex-col gap-2">
            <!-- ×‘×—×™×¨×ª ×¤×¢×•×œ×” -->
            <div class="flex justify-around bg-gray-100 p-2 rounded-xl shadow-inner">
                <button id="op-add" data-op="+" class="op-button bg-teal-600 active text-white" onclick="setOperation('+')">×—×™×‘×•×¨ (+)</button>
                <button id="op-subtract" data-op="-" class="op-button bg-gray-300 text-gray-700" onclick="setOperation('-')">×—×™×¡×•×¨ (-)</button>
                <button id="op-multiply" data-op="*" class="op-button bg-gray-300 text-gray-700" onclick="setOperation('*')">×›×¤×œ (Ã—)</button>
                <button id="op-divide" data-op="/" class="op-button bg-gray-300 text-gray-700" onclick="setOperation('/')">×—×™×œ×•×§ (Ã·)</button>
            </div>
            <!-- ×›×¤×ª×•×¨ ××¢×‘×¨ ××¦×‘ -->
             <button id="mode-toggle-button" class="bg-indigo-500 text-white p-2 rounded-xl font-bold shadow-md hover:bg-indigo-600 transition" onclick="toggleMode()">
                ×”×—×œ×£ ××¦×‘ (×›×¢×ª: ×‘×—×™×¨×” ××¨×•×‘×”)
            </button>
        </div>


        <!-- 2A. ××–×•×¨ ×”××¤×œ×¦×ª (Monster Area) - Monster ×•-Target / Equation ×–×” ×œ×¦×“ ×–×” -->
        <div class="relative flex items-center justify-around h-48 bg-purple-100 rounded-2xl p-4 shadow-inner">
            
            <!-- ×’×¨×¤×™×§×ª ×”××¤×œ×¦×ª -->
            <div id="monster-graphic" class="text-7xl animate-bounce-slow" style="animation-duration: 4s;">
                ğŸ‘¾
            </div>

            <!-- ××¡×¤×¨ ×”××˜×¨×” / ×ª×¨×’×™×œ -->
            <div id="target-display-area" class="bg-yellow-400 text-purple-800 rounded-xl py-4 px-4 shadow-xl text-4xl font-black border-4 border-white">
                <!-- ×‘××¦×‘ '××¦× ×©× ×™×™×': ×™×›×™×œ ××ª ××¡×¤×¨ ×”××˜×¨×” (target-number) -->
                <!-- ×‘××¦×‘ '×‘×—×™×¨×” ××¨×•×‘×”': ×™×›×™×œ ××ª ×”×ª×¨×’×™×œ (mc-equation) -->
                <span id="target-number">?</span>
            </div>

            <!-- ×”×•×“×¢×•×ª ××©×•×‘ -->
            <div id="feedback-message" class="monster-reaction"></div>
            <div id="confetti-container" class="confetti"></div>
        </div>

        <!-- 2B. ××–×•×¨ ×‘×—×™×¨×ª ×”××¡×¤×¨×™× (Find-Two Mode) -->
        <div id="orb-container" class="mode-find-two flex flex-wrap justify-center gap-2 min-h-[120px] p-2 bg-white rounded-xl shadow-lg border border-gray-200 hidden">
            <!-- ×›×“×•×¨×™ ×”××¡×¤×¨×™× ×™×•×›× ×¡×• ×›××Ÿ ×¢×œ ×™×“×™ JavaScript -->
        </div>
        
        <!-- 2B-MC. ××–×•×¨ ×‘×—×™×¨×” ××¨×•×‘×” (Multiple Choice Mode) -->
        <div id="mc-container" class="mode-mc grid grid-cols-2 gap-3 min-h-[120px] p-2 bg-white rounded-xl shadow-lg border border-gray-200">
             <!-- ×›×¤×ª×•×¨×™ ×”×ª×©×•×‘×•×ª ×™×•×›× ×¡×• ×›××Ÿ ×¢×œ ×™×“×™ JavaScript -->
        </div>


        <!-- 2C. ××–×•×¨ ×”×©×™×œ×•×‘ (Combination Area) - ××•×¡×ª×¨ ×‘××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×” -->
        <div id="combination-area" class="mode-find-two flex flex-col items-center gap-4 p-4 bg-white rounded-2xl shadow-xl border-t-4 border-blue-500 hidden">
            <div class="flex items-center justify-center gap-2 sm:gap-4 text-3xl font-bold">
                
                <!-- ×—×¨×™×¥ 1 -->
                <div id="slot-1" data-slot="1" class="slot w-20 h-20 rounded-full">?</div>

                <!-- ×¡×™××Ÿ ×¤×¢×•×œ×” -->
                <div id="equation-op" class="text-blue-600 text-4xl mx-2">+</div>
                
                <!-- ×—×¨×™×¥ 2 -->
                <div id="slot-2" data-slot="2" class="slot w-20 h-20 rounded-full">?</div>
                
                <!-- ×¡×™××Ÿ ×©×•×•×” -->
                <div class="text-gray-500 text-4xl mx-2">=</div>
                
                <!-- ×¡×™××Ÿ ×©××œ×” -->
                <div class="text-gray-500 text-4xl">?</div>
            </div>
            
            <!-- ×¨×™×•×•×— -->
            <div class="flex gap-4 w-full justify-center h-12">
            </div>
        </div>
        
        <!-- ×¨×™×•×•×— ×ª×—×ª×•×Ÿ -->
        <div class="h-8"></div> 

    </div>

<script>
    // ×”×’×“×¨×•×ª ×•×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×’×œ×•×‘×œ×™×•×ª
    const GameState = {
        target: 0, // ×”×ª×©×•×‘×” ×”× ×›×•× ×”
        operation: '+', 
        orbs: [], // ×¨×©×™××ª ×›×“×•×¨×™× ×œ××¦×‘ '××¦× ×©× ×™×™×'
        solution: { num1: 0, num2: 0 }, // ×”×¤×ª×¨×•×Ÿ ×œ××¦×‘ '××¦× ×©× ×™×™×'
        selectedOrbs: { 1: null, 2: null }, // { slotId: { value, originalId } }
        score: 0,
        streak: 0,
        isBusy: false,
        // *** ××¦×‘ ×”××©×—×§ ×”×—×“×© ***
        mode: 'multiple-choice', // ×©×™× ×•×™ ×‘×¨×™×¨×ª ×”××—×“×œ ×œ××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×”
        mcQuestion: { num1: 0, num2: 0, answer: 0, decoys: [] }, // × ×ª×•× ×™× ×œ××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×”
    };

    // Tone.js Setups
    let successSynth = null;
    let failureSynth = null;

    function initAudio() {
        try {
            // ×¦×œ×™×œ ×”×¦×œ×—×”: ×× ×’×™× ×” ×¢×•×œ×” ×§×¦×¨×”
            successSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: { attack: 0.01, decay: 0.1, sustain: 0.05, release: 0.1 }
            }).toDestination();
            
            // ×¦×œ×™×œ ×›×™×©×œ×•×Ÿ: ×˜×•×Ÿ ×™×•×¨×“ ×§×¦×¨
            failureSynth = new Tone.Synth({
                oscillator: { type: "square" },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.01, release: 0.2 }
            }).toDestination();

        } catch (e) {
            console.error("Tone.js initialization failed:", e);
        }
    }

    function playSuccessSound() {
        if (successSynth) {
            const now = Tone.now();
            successSynth.triggerAttackRelease(["C5", "E5", "G5"], "8n", now);
        }
    }

    function playFailureSound() {
        if (failureSynth) {
            const now = Tone.now();
            failureSynth.triggerAttackRelease("C4", "16n", now);
            failureSynth.triggerAttackRelease("A3", "16n", now + 0.1);
        }
    }

    // ×¤×•× ×§×¦×™×•×ª UI
    const scoreDisplay = document.getElementById('score-display');
    const streakDisplay = document.getElementById('streak-display');
    const targetDisplayArea = document.getElementById('target-display-area'); // ××›×™×œ ××ª ×”××¡×¤×¨/×ª×¨×’×™×œ
    const orbContainer = document.getElementById('orb-container'); // ××–×•×¨ ××¦× ×©× ×™×™×
    const mcContainer = document.getElementById('mc-container'); // ××–×•×¨ ×‘×—×™×¨×” ××¨×•×‘×”
    const slot1El = document.getElementById('slot-1');
    const slot2El = document.getElementById('slot-2');
    const feedbackMessageEl = document.getElementById('feedback-message');
    const monsterGraphicEl = document.getElementById('monster-graphic');
    const modeToggleButton = document.getElementById('mode-toggle-button');
    const combinationArea = document.getElementById('combination-area');

    // ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ××¢×‘×¨ ×‘×™×Ÿ ××¦×‘×™×
    function toggleMode() {
        if (GameState.isBusy) return;

        GameState.mode = (GameState.mode === 'find-two') ? 'multiple-choice' : 'find-two';
        GameState.score = 0; // ××™×¤×•×¡ × ×™×§×•×“ ×•×¨×¦×£ ×‘××¢×‘×¨ ××¦×‘
        GameState.streak = 0;
        
        modeToggleButton.textContent = (GameState.mode === 'find-two') ? 
            '×”×—×œ×£ ××¦×‘ (×›×¢×ª: ××¦× ×©× ×™×™×)' : 
            '×”×—×œ×£ ××¦×‘ (×›×¢×ª: ×‘×—×™×¨×” ××¨×•×‘×”)';
        
        // ×”×¦×’×”/×”×¡×ª×¨×” ×©×œ ××–×•×¨×™ ×”××©×—×§
        orbContainer.classList.toggle('hidden', GameState.mode !== 'find-two');
        combinationArea.classList.toggle('hidden', GameState.mode !== 'find-two');
        mcContainer.classList.toggle('hidden', GameState.mode !== 'multiple-choice');

        // ×˜×¢×™× ×ª ×‘×¢×™×” ×—×“×©×” ×‘××¦×‘ ×”×—×“×©
        generateProblem();
    }

    // ×¤×•× ×§×¦×™×” ×œ×©×™× ×•×™ ×¤×¢×•×œ×”
    function setOperation(op) {
        if (GameState.operation === op) return;

        GameState.operation = op;
        GameState.score = 0; // ××™×¤×•×¡ × ×™×§×•×“ ×•×¨×¦×£ ×‘××¢×‘×¨ ×‘×™×Ÿ ×¤×¢×•×œ×•×ª
        GameState.streak = 0;

        // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™×
        document.querySelectorAll('.op-button').forEach(btn => {
            btn.classList.remove('active', 'bg-teal-600', 'text-white');
            btn.classList.add('bg-gray-300', 'text-gray-700');
            if (btn.dataset.op === op) {
                btn.classList.add('active', 'bg-teal-600', 'text-white');
                btn.classList.remove('bg-gray-300', 'text-gray-700');
            }
        });
        
        generateProblem();
    }


    function updateUI() {
        scoreDisplay.textContent = GameState.score;
        streakDisplay.textContent = GameState.streak;
        
        // ×”×—×œ×¤×ª ×¡×™×× ×™× ×‘×××©×§ ×œ×˜×§×¡×˜ ×”× ×›×•×Ÿ
        let opSymbol = GameState.operation;
        if (opSymbol === '*') opSymbol = 'Ã—';
        if (opSymbol === '/') opSymbol = 'Ã·';
        document.getElementById('equation-op').textContent = opSymbol;

        // ×¢×“×›×•×Ÿ ××–×•×¨ ×”××˜×¨×” ×‘×”×ª×× ×œ××¦×‘
        if (GameState.mode === 'find-two') {
            targetDisplayArea.innerHTML = `<span id="target-number">${GameState.target}</span>`;
            targetDisplayArea.classList.add('rounded-full', 'py-3', 'px-8');
            targetDisplayArea.classList.remove('rounded-xl', 'py-4', 'px-4', 'text-4xl');
        } else { // multiple-choice
            targetDisplayArea.innerHTML = `<span id="mc-equation">${GameState.mcQuestion.num1} ${opSymbol} ${GameState.mcQuestion.num2} = ?</span>`;
            targetDisplayArea.classList.remove('rounded-full', 'py-3', 'px-8');
            targetDisplayArea.classList.add('rounded-xl', 'py-4', 'px-4', 'text-4xl'); // ×¡×’× ×•×Ÿ ××œ×‘× ×™ ×œ×ª×¨×’×™×œ
            renderMultipleChoiceButtons(GameState.mcQuestion.answers);
        }


        if (GameState.mode === 'find-two') {
            // ×¢×“×›×•×Ÿ ×—×¨×™×¦×™×
            renderSlot(slot1El, GameState.selectedOrbs[1]);
            renderSlot(slot2El, GameState.selectedOrbs[2]);
            renderOrbs();
        }
    }

    function renderSlot(slotEl, orbData) {
        if (orbData) {
            slotEl.textContent = orbData.value;
            slotEl.style.backgroundColor = '#60a5fa'; // Blue when filled
            slotEl.style.color = 'white';
            slotEl.style.border = '4px solid #3b82f6';
        } else {
            slotEl.textContent = '?';
            slotEl.style.backgroundColor = '#e0f2fe'; // Light blue when empty
            slotEl.style.color = '#6366f1';
            slotEl.style.border = '4px dashed #90cdf4';
        }
    }

    function renderOrbs() {
        orbContainer.innerHTML = '';
        GameState.orbs.forEach(orb => {
            if (!orb.inSlot) {
                const orbEl = document.createElement('div');
                orbEl.id = `orb-${orb.id}`;
                orbEl.textContent = orb.value;
                orbEl.className = 'orb w-14 h-14 rounded-full bg-pink-500 text-white';
                orbEl.dataset.value = orb.value;
                orbEl.dataset.id = orb.id;
                orbEl.addEventListener('click', handleOrbClick);
                orbContainer.appendChild(orbEl);
            }
        });
    }

    function renderMultipleChoiceButtons(answers) {
        mcContainer.innerHTML = '';
        answers.forEach(answer => {
            const buttonEl = document.createElement('button');
            buttonEl.textContent = answer;
            buttonEl.className = 'mc-button bg-pink-500 text-white hover:bg-pink-600 transition';
            buttonEl.dataset.answer = answer;
            buttonEl.addEventListener('click', handleMultipleChoiceClick);
            mcContainer.appendChild(buttonEl);
        });
    }


    function showFeedback(message, isSuccess) {
        feedbackMessageEl.textContent = message;
        feedbackMessageEl.className = 'monster-reaction ' + (isSuccess ? 'text-green-600' : 'text-red-600');
        feedbackMessageEl.style.opacity = 1;

        // ×”×¤×¢×œ×” ××—×“×© ×©×œ ×× ×™××¦×™×”
        feedbackMessageEl.style.animation = 'none';
        void feedbackMessageEl.offsetWidth; // Force reflow
        feedbackMessageEl.style.animation = 'fadePop 1s ease-out';
    }

    function showConfetti() {
        const confettiContainer = document.getElementById('confetti-container');
        confettiContainer.innerHTML = '';
        const count = 30;
        for (let i = 0; i < count; i++) {
            const particle = document.createElement('div');
            particle.className = 'absolute w-2 h-2 rounded-full';
            particle.style.backgroundColor = ['#f97316', '#ef4444', '#f59e0b', '#10b981', '#3b82f6'][Math.floor(Math.random() * 5)];
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.animation = `confetti-fall ${Math.random() * 2 + 1}s ease-out ${Math.random() * 0.5}s forwards`;
            confettiContainer.appendChild(particle);
        }

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes confetti-fall {
                0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
                100% { transform: translateY(100vh) rotate(${Math.random() * 720 + 360}deg) scale(0); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        setTimeout(() => confettiContainer.innerHTML = '', 1500); // × ×™×§×•×™ ××—×¨×™ 1.5 ×©× ×™×•×ª
    }


    // ×œ×•×’×™×§×ª ×™×¦×™×¨×ª ×‘×¢×™×•×ª
    
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    /**
     * ××—×©×‘ ××ª ×”×ª×•×¦××” ×©×œ ×ª×¨×’×™×œ ×‘×”×ª×× ×œ×¤×¢×•×œ×”.
     */
    function calculateResult(num1, num2, op) {
        let result;
        if (op === '+') {
            result = num1 + num2;
        } else if (op === '*') {
            result = num1 * num2;
        } else if (op === '-') {
            // ×‘×—×™×¡×•×¨: ×ª××™×“ ×”×’×“×•×œ ×¤×—×•×ª ×”×§×˜×Ÿ
            result = Math.max(num1, num2) - Math.min(num1, num2);
        } else if (op === '/') {
            // ×‘×—×™×œ×•×§: ×ª××™×“ ×”×’×“×•×œ ×—×œ×§×™ ×”×§×˜×Ÿ.
            const maxVal = Math.max(num1, num2);
            const minVal = Math.min(num1, num2);
            if (minVal === 0 || maxVal % minVal !== 0) {
                 result = -1; // ×ª×•×¦××” ×œ× ×©×œ××”
            } else {
                 result = maxVal / minVal;
            }
        }
        return result;
    }


    function generateBaseProblem(op) {
        let num1, num2, target;
        const minVal = 1; 

        if (op === '+') {
            num1 = getRandomInt(minVal, 10);
            num2 = getRandomInt(minVal, 10);
            target = num1 + num2;
            
        } else if (op === '-') {
            // ×—×™×¡×•×¨, ×ª×•×¦××” ×—×™×•×‘×™×ª ×¢×“ 10
            num1 = getRandomInt(5, 20); 
            num2 = getRandomInt(1, num1 - 4); 
            target = num1 - num2;
            
        } else if (op === '*') {
            // ×›×¤×œ (×œ×•×— 10x10)
            num1 = getRandomInt(minVal, 10);
            num2 = getRandomInt(minVal, 10);
            target = num1 * num2;
            
        } else if (op === '/') {
            // ×—×™×œ×•×§ (×œ×•×— 10x10)
            let factor1 = getRandomInt(minVal, 10);
            let factor2 = getRandomInt(minVal, 10);
            target = factor1; // ×”×ª×•×¦××”
            num1 = factor1 * factor2; // ×”××—×•×œ×§ (×”×’×“×•×œ)
            num2 = factor2; // ×”××—×œ×§
        }

        return { num1, num2, target };
    }

    function generateProblem() {
        const op = GameState.operation;
        const minOrbs = 6;
        const maxOrbs = 8;
        const minVal = 1;

        const baseProblem = generateBaseProblem(op);
        GameState.target = baseProblem.target;
        
        // --- ××¦×‘ ××¦× ×©× ×™×™× ---
        if (GameState.mode === 'find-two') {
            
            // ×‘××¦×‘ ××¦× ×©× ×™×™×, ×”×¤×ª×¨×•×Ÿ ×”×•× ×©× ×™ ×”××¡×¤×¨×™× ×©×™×•×¦×¨×™× ××ª ×”-Target
            // ×”×‘×¢×™×” ×”×‘×¡×™×¡×™×ª ××™×™×¦×¨×ª ××ª num1, num2 ×›×¤×ª×¨×•×Ÿ
            GameState.solution = { num1: baseProblem.num1, num2: baseProblem.num2 };
            
            let solutionNumbers = [baseProblem.num1, baseProblem.num2];
            const orbCount = getRandomInt(minOrbs, maxOrbs);
            let allOrbs = [...solutionNumbers];

            // ×”×•×¡×¤×ª ××¡×¤×¨×™× ××˜×¢×™×
            while (allOrbs.length < orbCount) {
                let decoy;
                let maxDecoy = (op === '*') ? 10 : (op === '/') ? 10 : 20;

                do {
                    decoy = getRandomInt(minVal, maxDecoy); 
                } while (allOrbs.includes(decoy) || solutionNumbers.includes(decoy));

                allOrbs.push(decoy);
            }

            // ×¢×¨×‘×•×‘ ×•×”×›× ×ª ×”××¦×‘
            allOrbs.sort(() => Math.random() - 0.5);
            GameState.orbs = allOrbs.map((value, index) => ({
                id: index,
                value: value,
                inSlot: null // null, 1, or 2
            }));

            GameState.selectedOrbs = { 1: null, 2: null };


        // --- ××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×” ---
        } else {
            // ×‘××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×”, ×”-Target ×”×•× ×”×ª×©×•×‘×” ×©×œ ×”×ª×¨×’×™×œ num1 op num2
            GameState.mcQuestion = { 
                num1: baseProblem.num1, 
                num2: baseProblem.num2, 
                answer: baseProblem.target
            };

            const answers = [baseProblem.target];
            // const maxAnswerRange = (op === '*' || op === '/') ? 100 : 50;
            
            // ×™×¦×™×¨×ª 3 ×ª×©×•×‘×•×ª ××˜×¢×•×ª
            while (answers.length < 4) {
                let decoy;
                
                do {
                    // ×™×¦×™×¨×ª ×ª×©×•×‘×” ××˜×¢×” ×§×¨×•×‘×”
                    decoy = baseProblem.target + getRandomInt(-5, 5);
                    if (op === '*' || op === '/') {
                        decoy = baseProblem.target + getRandomInt(-2, 2); // ×§×¨×•×‘×•×ª ×™×•×ª×¨ ×‘×›×¤×œ/×—×™×œ×•×§
                    }

                    // ×œ×•×•×“× ×©×”××¡×¤×¨×™× ×œ× ×©×œ×™×œ×™×™× ×•×©×”× ×©×•× ×™× ××”×ª×©×•×‘×•×ª ×”×§×™×™××•×ª
                } while (decoy <= 0 || answers.includes(decoy));
                
                answers.push(decoy);
            }

            // ×¢×¨×‘×•×‘ ×”×ª×©×•×‘×•×ª
            answers.sort(() => Math.random() - 0.5);
            GameState.mcQuestion.answers = answers;
        }


        GameState.isBusy = false;
        
        // ×¢×“×›×•×Ÿ UI
        updateUI();
        monsterGraphicEl.textContent = ['ğŸ‘¾', 'ğŸ‘½', 'ğŸ‘»', 'ğŸ¤–', 'ğŸ¦ '][Math.floor(Math.random() * 5)];
    }


    function resetSlots() {
        // ××—×–×™×¨ ××ª ×”×›×“×•×¨×™× ×œ×—×œ×•×Ÿ ×”×‘×—×™×¨×” ×•×× ×§×” ××ª ×”×—×¨×™×¦×™×
        if (GameState.selectedOrbs[1]) {
            GameState.orbs.find(o => o.id === GameState.selectedOrbs[1].originalId).inSlot = null;
        }
        if (GameState.selectedOrbs[2]) {
            GameState.orbs.find(o => o.id === GameState.selectedOrbs[2].originalId).inSlot = null;
        }
        GameState.selectedOrbs = { 1: null, 2: null };

        updateUI();
        renderOrbs();
    }

    /**
     * ××¤×¢×™×œ ××ª ×”×‘×“×™×§×” ×”××•×˜×•××˜×™×ª ×œ××—×¨ ×©×”××©×ª××© ×”×¦×™×‘ ×©× ×™ ××¡×¤×¨×™× (×‘××¦×‘ '××¦× ×©× ×™×™×').
     */
    function checkFindTwo() {
        if (GameState.isBusy || !GameState.selectedOrbs[1] || !GameState.selectedOrbs[2]) return;
        GameState.isBusy = true;

        const val1 = GameState.selectedOrbs[1].value;
        const val2 = GameState.selectedOrbs[2].value;

        // ×‘××¦×‘ '××¦× ×©× ×™×™×', ×”×ª×©×•×‘×” ×”× ×›×•× ×” ×”×™× Target Number
        const result = calculateResult(val1, val2, GameState.operation);
        
        if (result === GameState.target) {
            handleSuccess();
        } else {
            handleFailure();
        }
    }

    /**
     * ××˜×¤×œ ×‘×œ×—×™×¦×” ×¢×œ ×›×“×•×¨ (×”×–×–×” ×œ×—×¨×™×¥ ×”×¤× ×•×™ ×”×¨××©×•×Ÿ) - ××¦×‘ '××¦× ×©× ×™×™×'
     */
    function handleOrbClick(event) {
        if (GameState.isBusy) return;

        const orbEl = event.currentTarget;
        const value = parseInt(orbEl.dataset.value);
        const originalId = parseInt(orbEl.dataset.id);

        let targetSlotId = null;

        // ××¦× ×—×¨×™×¥ ×¤× ×•×™
        if (!GameState.selectedOrbs[1]) {
            targetSlotId = 1;
        } else if (!GameState.selectedOrbs[2]) {
            targetSlotId = 2;
        }

        if (targetSlotId) {
            // ×× ×™×© ×—×¨×™×¥ ×¤× ×•×™, ×”×¢×‘×¨ ××œ×™×•
            GameState.selectedOrbs[targetSlotId] = { value, originalId };
            GameState.orbs.find(o => o.id === originalId).inSlot = targetSlotId;
            
            // ×”×¡×¨ ××ª ×”×›×“×•×¨ ×××–×•×¨ ×”×‘×—×™×¨×”
            orbEl.removeEventListener('click', handleOrbClick);
            orbEl.style.display = 'none';

            updateUI(); // ×¢×“×›×Ÿ ××ª ×”-UI ×›×“×™ ×œ×”×¦×™×’ ××ª ×”××¡×¤×¨ ×‘×—×¨×™×¥

            // *** ×”×¤×¢×œ ×‘×“×™×§×” ××•×˜×•××˜×™×ª ×× ×©× ×™ ×”×—×¨×™×¦×™× ××œ××™× ***
            if (GameState.selectedOrbs[1] && GameState.selectedOrbs[2]) {
                // ×”××ª×Ÿ ××¢×˜ ×›×“×™ ×œ××¤×©×¨ ×œ××©×ª××© ×œ×¨××•×ª ××ª ×”×”×¦×‘×”
                setTimeout(checkFindTwo, 300); 
            }

        } else {
            // ×œ×•×’×™×§×” ×œ×”×—×œ×¤×ª ×”×¨××©×•×Ÿ (×›×¤×™ ×©×”×•×’×“×¨ ×§×•×“×)
            const oldOrbData = GameState.selectedOrbs[1];
            if(oldOrbData) {
                // 1. ×”×—×–×¨ ××ª ×”×›×“×•×¨ ×”×™×©×Ÿ ×œ××–×•×¨ ×”×‘×—×™×¨×”
                GameState.orbs.find(o => o.id === oldOrbData.originalId).inSlot = null;
                
                // 2. ×¢×“×›×Ÿ ××ª ×”×—×¨×™×¥ 1 ×‘×›×“×•×¨ ×”×—×“×©
                GameState.selectedOrbs[1] = { value, originalId };
                GameState.orbs.find(o => o.id === originalId).inSlot = 1;
            
                // 3. ×¨× ×“×¨ ××—×“×©
                renderOrbs();
                updateUI();
            }
        }
    }

    // ××˜×¤×œ ×‘×œ×—×™×¦×” ×¢×œ ×—×¨×™×¥ (×”×—×–×¨×ª ×”×›×“×•×¨ ×œ××–×•×¨ ×”×‘×—×™×¨×”) - ××¦×‘ '××¦× ×©× ×™×™×'
    function handleSlotClick(event) {
        if (GameState.isBusy) return;

        const slotEl = event.currentTarget;
        const slotId = parseInt(slotEl.dataset.slot);
        
        if (GameState.selectedOrbs[slotId]) {
            // ×”×—×–×¨ ××ª ×”×›×“×•×¨ ×œ××–×•×¨ ×”×‘×—×™×¨×”
            const originalId = GameState.selectedOrbs[slotId].originalId;
            GameState.orbs.find(o => o.id === originalId).inSlot = null;
            
            // × ×§×” ××ª ×”×—×¨×™×¥
            GameState.selectedOrbs[slotId] = null;

            updateUI();
            renderOrbs(); // ×¨× ×“×¨ ××—×“×© ××ª ×”×›×“×•×¨×™× ×›×“×™ ×œ×”×¦×™×’ ××ª ×”×›×“×•×¨ ×©×”×•×—×–×¨
        }
    }

    /**
     * ××˜×¤×œ ×‘×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×ª×©×•×‘×” ×‘××¦×‘ '×‘×—×™×¨×” ××¨×•×‘×”'
     */
    function handleMultipleChoiceClick(event) {
        if (GameState.isBusy) return;
        GameState.isBusy = true;

        const buttonEl = event.currentTarget;
        const selectedAnswer = parseInt(buttonEl.dataset.answer);
        const isCorrect = selectedAnswer === GameState.mcQuestion.answer;

        // ×¡×™××•×Ÿ ×•×™×–×•××œ×™ ××”×™×¨ ×©×œ ×”×ª×©×•×‘×”
        buttonEl.classList.remove('bg-pink-500', 'hover:bg-pink-600');
        buttonEl.classList.add(isCorrect ? 'bg-green-500' : 'bg-red-500');

        if (isCorrect) {
            handleSuccess();
        } else {
            handleFailure(true, buttonEl); // True ×›×“×™ ×œ× ×§×•×ª ×¨×§ ××ª ×”×›×¤×ª×•×¨ ×©× ×œ×—×¥
        }
    }

    function handleSuccess() {
        playSuccessSound();
        showFeedback("××¤×œ×¦×ª ×©×‘×¢×”! ğŸ‰", true);
        showConfetti();

        // ×¢×“×›×•×Ÿ × ×™×§×•×“ ×•×¨×¦×£
        GameState.score += 10;
        GameState.streak += 1;
        
        // ×× ×™××¦×™×™×ª '×‘×œ×™×¢×”' / ×©××—×”
        if (GameState.mode === 'find-two') {
            slot1El.classList.add('transition-all', 'duration-500', 'translate-y-[-100px]', 'opacity-0');
            slot2El.classList.add('transition-all', 'duration-500', 'translate-y-[-100px]', 'opacity-0');
        }
        monsterGraphicEl.classList.add('animate-ping-once', 'text-yellow-500'); // ×× ×™××¦×™×™×ª ×©××—×”

        if (GameState.streak % 5 === 0 && GameState.streak > 0) {
            setTimeout(() => {
                showFeedback(`â­ ×¤×ª×—×ª× ×¤×¨×™×˜ ×—×“×©! ×¨×¦×£ ${GameState.streak} â­`, true);
            }, 1000);
        }

        setTimeout(() => {
            // × ×™×§×•×™ ×•×”×ª×—×œ×” ××—×“×©
            if (GameState.mode === 'find-two') {
                slot1El.classList.remove('transition-all', 'duration-500', 'translate-y-[-100px]', 'opacity-0');
                slot2El.classList.remove('transition-all', 'duration-500', 'translate-y-[-100px]', 'opacity-0');
            }
            // ××™×¤×•×¡ ×›×¤×ª×•×¨×™ ×‘×—×™×¨×” ××¨×•×‘×”
            document.querySelectorAll('.mc-button').forEach(btn => {
                btn.classList.remove('bg-green-500', 'bg-red-500');
                btn.classList.add('bg-pink-500', 'hover:bg-pink-600');
            });
            
            monsterGraphicEl.classList.remove('animate-ping-once', 'text-yellow-500');

            generateProblem(); // ×˜×¢×™× ×ª ×”××¤×œ×¦×ª ×”×‘××”
            updateUI();
        }, 1500);
    }

    function handleFailure(isMultipleChoice = false, failedButton = null) {
        playFailureSound();
        showFeedback("× ×¡×” ×©×•×‘! ğŸ™", false);
        
        // ×¢×“×›×•×Ÿ × ×™×§×•×“ ×•×¨×¦×£
        GameState.score = Math.max(0, GameState.score - 3); // ×œ× ×™×•×¨×“ ××ª×—×ª ×œ-0
        GameState.streak = 0;

        // ×× ×™××¦×™×™×ª ×›×™×©×œ×•×Ÿ
        monsterGraphicEl.classList.add('animate-shake', 'text-red-500');

        setTimeout(() => {
            monsterGraphicEl.classList.remove('animate-shake', 'text-red-500');
            
            if (GameState.mode === 'find-two') {
                resetSlots();
            } else if (isMultipleChoice && failedButton) {
                // ×‘××¦×‘ ×‘×—×™×¨×” ××¨×•×‘×”, ×¤×©×•×˜ ××—×–×™×¨×™× ××ª ×”×›×¤×ª×•×¨ ×©× ×œ×—×¥ ×œ××¦×‘ ×¨×’×™×œ
                failedButton.classList.remove('bg-red-500');
                failedButton.classList.add('bg-pink-500', 'hover:bg-pink-600');
            }

            GameState.isBusy = false;
        }, 1000);
    }
    
    // Event Listeners for Slots (for replacement/removal) - ××¦×‘ ××¦× ×©× ×™×™×
    slot1El.addEventListener('click', handleSlotClick);
    slot2El.addEventListener('click', handleSlotClick);

    // ×”×’×“×¨×ª ×× ×™××¦×™×•×ª
    const style = document.createElement('style');
    style.innerHTML += `
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 4s infinite ease-in-out;
        }
    `;
    document.head.appendChild(style);

    // ××ª×—×•×œ ×”××©×—×§
    window.onload = function() {
        initAudio();
        // ×”×’×“×¨×ª ×”××¦×‘ ×”×”×ª×—×œ×ª×™: 'multiple-choice'
        GameState.mode = 'multiple-choice';
        
        // ×§×•×¨××™× ×œ-setOperation ×¢× ×‘×¨×™×¨×ª ×”××—×“×œ (+) ×›×“×™ ×œ××ª×—×œ ××ª ×”×›×¤×ª×•×¨×™× ×•××ª ×”×‘×¢×™×” ×”×¨××©×•× ×”
        setOperation('+'); 
        
        // ×¢×“×›×•×Ÿ ×˜×§×¡×˜ ×”×›×¤×ª×•×¨ ×œ××—×¨ ×”××ª×—×•×œ
        modeToggleButton.textContent = '×”×—×œ×£ ××¦×‘ (×›×¢×ª: ×‘×—×™×¨×” ××¨×•×‘×”)';
    };
</script>
</body>
</html>
